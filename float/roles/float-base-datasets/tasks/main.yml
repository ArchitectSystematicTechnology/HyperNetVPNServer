---

- name: Create a group to allow reading tabacco configs
  group:
    name: tabacco
    system: yes
    state: present

- name: Create backup config and scratch directories
  file:
    path: "{{ item }}"
    state: directory
    mode: 0750
    group: tabacco
  with_items:
    - /etc/tabacco
    - /etc/tabacco/sources
    - /etc/tabacco/handlers
    - /var/lib/tabacco
    - /var/cache/tabacco

- name: Create backup agent config
  template:
    src: agent.yml.j2
    dest: /etc/tabacco/agent.yml
    mode: 0600
  when: backup_repository_uri is defined
  notify:
    - reload backup agent

- name: Enable backup agent systemd unit
  systemd:
    name: tabacco-agent.service
    masked: no
    enabled: yes
  when: backup_repository_uri is defined

- file:
    path: /usr/lib/float/datasets
    state: directory

- include_tasks: dataset.yml
  loop: "{{ services | subelements('datasets', skip_missing=True) }}"
